"""
Unit tests for Vulnerability Scanner Agent.

Tests vulnerability scanning, risk assessment, and remediation tracking.
Part of: TASK-2305 Security Swarm
"""

import pytest
from unittest.mock import AsyncMock
from datetime import datetime

from src.agents.operational.security.vulnerability_scanner import VulnerabilityScannerAgent
from src.workflow.state import create_initial_state


@pytest.fixture
def agent():
    """Create VulnerabilityScannerAgent instance."""
    return VulnerabilityScannerAgent()


class TestVulnerabilityScannerInitialization:
    """Test Vulnerability Scanner initialization."""

    def test_agent_initialization(self, agent):
        """Test agent initializes correctly."""
        assert agent.config.name == "vulnerability_scanner"
        assert agent.config.tier == "operational"


class TestVulnerabilityScanning:
    """Test vulnerability scanning logic."""

    @pytest.mark.asyncio
    async def test_successful_vulnerability_scan(self, agent):
        """Test successful vulnerability scan."""
        state = create_initial_state(
            message="Scan for vulnerabilities",
            context={}
        )
        state["entities"] = {
            "scan_type": "full",
            "target": "web_application"
        }

        result = await agent.process(state)

        assert result["status"] == "resolved"
        assert "agent_response" in result

    @pytest.mark.asyncio
    async def test_dependency_vulnerability_scan(self, agent):
        """Test dependency vulnerability scanning."""
        state = create_initial_state(message="Scan dependencies", context={})
        state["entities"] = {"scan_type": "dependencies"}

        result = await agent.process(state)

        assert result["status"] == "resolved"

    @pytest.mark.asyncio
    async def test_risk_assessment(self, agent):
        """Test vulnerability risk assessment."""
        state = create_initial_state(message="Assess vulnerability risks", context={})
        state["entities"] = {"assessment_type": "risk"}

        result = await agent.process(state)

        assert result["status"] == "resolved"


class TestEdgeCases:
    """Test edge cases."""

    @pytest.mark.asyncio
    async def test_handles_no_vulnerabilities(self, agent):
        """Test handling when no vulnerabilities found."""
        state = create_initial_state(message="Scan for vulnerabilities", context={})
        state["entities"] = {"scan_type": "quick"}

        result = await agent.process(state)

        assert result["status"] == "resolved"
