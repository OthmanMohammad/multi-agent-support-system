# =============================================================================
# POSTGRESQL PRODUCTION CONFIGURATION
# Optimized for Oracle Cloud ARM64 - 6GB allocated
# =============================================================================

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Listen on all interfaces for Docker network connectivity
listen_addresses = '*'
port = 5432

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================

# Total RAM allocated to PostgreSQL: 6GB
# Effective system RAM: 24GB (25% allocated)

shared_buffers = 1536MB                    # 25% of allocated RAM (6GB)
effective_cache_size = 4608MB              # 75% of allocated RAM
maintenance_work_mem = 384MB               # 1/16 of allocated RAM
work_mem = 16MB                            # For sorting/hashing operations

# Temporary memory
temp_buffers = 32MB

# =============================================================================
# WAL (Write-Ahead Logging) CONFIGURATION
# =============================================================================

wal_buffers = 16MB                         # -1 = auto (1/32 of shared_buffers)
wal_level = replica                        # For potential replication
wal_compression = on                       # Compress WAL

# Checkpoints
checkpoint_timeout = 10min                 # Range: 30s-1d
checkpoint_completion_target = 0.9         # Spread checkpoint I/O
checkpoint_warning = 5min

# Archive (disabled by default)
archive_mode = off

# =============================================================================
# QUERY PLANNER CONFIGURATION
# =============================================================================

# Cost factors (SSD optimized)
random_page_cost = 1.1                     # SSD: 1.1, HDD: 4.0
effective_io_concurrency = 200             # SSD: 200, HDD: 2

# Planner statistics
default_statistics_target = 100            # Default: 100, Range: 1-10000

# Parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 4

# =============================================================================
# CONNECTION CONFIGURATION
# =============================================================================

max_connections = 200                      # Adjust based on app needs
superuser_reserved_connections = 3

# Connection pooling recommended (use PgBouncer if needed)

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Where to log
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = 1000          # Log queries > 1 second
log_connections = on
log_disconnections = on
log_duration = off
log_hostname = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'mod'                      # none, ddl, mod, all
log_timezone = 'UTC'

# Lock monitoring
log_lock_waits = on
deadlock_timeout = 1s

# =============================================================================
# AUTOVACUUM CONFIGURATION
# =============================================================================

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# Vacuum cost-based delay (prevent I/O spike)
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# Thresholds
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Statement behavior
statement_timeout = 60000                  # 60 seconds (in ms)
lock_timeout = 30000                       # 30 seconds (in ms)
idle_in_transaction_session_timeout = 300000  # 5 minutes (in ms)

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Vacuum cost-based delay (for manual vacuums)
vacuum_cost_delay = 0
vacuum_cost_limit = 200

# Background writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Async commit (slight durability trade-off for performance)
synchronous_commit = on                    # on = max durability

# Full page writes (for crash safety)
full_page_writes = on

# =============================================================================
# REPLICATION (Prepared for future use)
# =============================================================================

wal_keep_size = 1GB                        # Keep WAL for replicas
max_wal_senders = 3                        # Number of replication connections
wal_sender_timeout = 60s

# =============================================================================
# RESOURCE USAGE
# =============================================================================

# Memory
shared_memory_type = mmap

# Disk
temp_file_limit = -1                       # Unlimited temp files

# Kernel Resource Usage
max_files_per_process = 1000

# =============================================================================
# ERROR HANDLING
# =============================================================================

exit_on_error = off
restart_after_crash = on

# =============================================================================
# STATISTICS
# =============================================================================

track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statistics targets
# stats_temp_directory = '/var/run/postgresql'  # Removed in PostgreSQL 15

# =============================================================================
# CLIENT AUTHENTICATION (see pg_hba.conf)
# =============================================================================

# SSL (disabled for internal Docker network)
ssl = off

# =============================================================================
# EXTENSIONS & FEATURES
# =============================================================================

shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
